<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
<!--chart js-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<!--date range picker-->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <title>Slovakia Vaccinations</title>
</head>
<body>
<main>

    <input type="SlovakiaVaccinationsRange" name="SlovakiaVaccinationsRange" />
    <div>
        <canvas id="SlovakiaVaccinations"></canvas>
    </div>
    <div>
        <canvas id="Dose1Vaccination"></canvas>
    </div>

<script>
    const CHART_COLORS = {
        red: 'rgb(255, 99, 132)',
        orange: 'rgb(255, 159, 64)',
        yellow: 'rgb(255, 205, 86)',
        green: 'rgb(75, 192, 192)',
        blue: 'rgb(54, 162, 235)',
        purple: 'rgb(153, 102, 255)',
        grey: 'rgb(201, 203, 207)'
    };

    const BACKGROUND_CHART_COLORS = {
        red: 'rgba(255, 99, 132, 0.5)',
        orange: 'rgba(255, 159, 64, 0.5)',
        yellow: 'rgba(255, 205, 86, 0.5)',
        green: 'rgba(75, 192, 192, 0.5)',
        blue: 'rgba(54, 162, 235, 0.5)',
        purple: 'rgba(153, 102, 255, 0.5)',
        grey: 'rgba(201, 203, 207, 0.5)'
    }

    // memory for data
    let dose1Count = [];
    let dose2Count = [];
    let dose1Sum = [];
    let dose2Sum = [];
    let updatedAt = [];
    let publishedOn = [];

    // indices for range selection
    let startIndexSlovakia = 0;
    let endIndexSlovakia = 0;

    const millisecondsInDay = 1000 * 3600 * 24;
    var myChart = new Chart(document.getElementById("SlovakiaVaccinations").getContext("2d"), {});

    fetchVaccinationData("http://localhost:8080/api/slovakiaVaccinations");
    // selectDataAndPlotSlovakiaVaccinations();

    async function fetchVaccinationData(url) {
        await fetch(url)
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    return Promise.reject(new Error(`Vaccination data acquisition failed. Server answered with ${response.status}: ${response.statusText}.`));
                }
            })
            .then(data => {
                // filling memory
                const dataLength = data.length;
                for (let i = 0; i < dataLength; i++) {
                    dose1Count[i] = data[i].dose1Count;
                    dose2Count[i] = data[i].dose2Count;
                    dose1Sum[i] = data[i].dose1Sum;
                    dose2Sum[i] = data[i].dose2Sum;
                    updatedAt[i] = data[i].updatedAt;
                    publishedOn[i] = data[i].publishedOn;
                }
                dose1Count.reverse();
                dose2Count.reverse();
                dose1Sum.reverse();
                dose2Sum.reverse();
                updatedAt.reverse();
                publishedOn.reverse();

                myChart.destroy();
                plotSlovakiaVaccinations(dose1Count, dose2Count, dose1Sum, dose2Sum, publishedOn);
                createDatePickerSlovakia();
            })
    }

    function createDatePickerSlovakia() {
        let minDate = createDate(publishedOn[0]);
        let maxDate = createDate(publishedOn[publishedOn.length - 1]);
        $(function() {
            $('input[name="SlovakiaVaccinationsRange"]').daterangepicker({
                opens: 'left',
                minDate: minDate,
                maxDate: maxDate,
                startDate: minDate,
                endDate: maxDate
            }, function(start, end, label) {
                startIndexSlovakia = (start._d.getTime() - minDate.getTime()) / millisecondsInDay;
                endIndexSlovakia = (end._d.getTime() - minDate.getTime()) / millisecondsInDay;
                myChart.destroy();
                selectDataAndPlotSlovakiaVaccinations();
            });
        });
    }

    function createDate(date) {
        return new Date(parseInt(date.substring(0, 4)), parseInt(date.substring(5, 7)) - 1, parseInt(date.substring(8, 10)));
    }

    function selectDataAndPlotSlovakiaVaccinations() {
        let dose1CountNew = [];
        let dose2CountNew = [];
        let dose1SumNew = [];
        let dose2SumNew = [];
        let publishedOnNew = [];

        for (let i = startIndexSlovakia; i < endIndexSlovakia; i++) {
            dose1CountNew[i - startIndexSlovakia] = dose1Count[i];
            dose2CountNew[i - startIndexSlovakia] = dose2Count[i];
            dose1SumNew[i - startIndexSlovakia] = dose1Sum[i];
            dose2SumNew[i - startIndexSlovakia] = dose2Sum[i];
            publishedOnNew[i - startIndexSlovakia] = publishedOn[i];
        }

        plotSlovakiaVaccinations(dose1CountNew, dose2CountNew, dose1SumNew, dose2SumNew, publishedOnNew);
    }

    function plotSlovakiaVaccinations(dose1Count, dose2Count, dose1Sum, dose2Sum, publishedOn) {
        const data = {
            labels: publishedOn,
            datasets: [
                {
                    type: 'bar',
                    label: "Dose 1",
                    yAxisID: 'Dose',
                    backgroundColor: BACKGROUND_CHART_COLORS.red,
                    borderColor: CHART_COLORS.red,
                    borderWidth: 2,
                    data: dose1Count
                },
                {
                    type: 'bar',
                    label: "Dose 2",
                    yAxisID: 'Dose',
                    backgroundColor: BACKGROUND_CHART_COLORS.blue,
                    borderColor: CHART_COLORS.blue,
                    borderWidth: 2,
                    data: dose2Count
                },
                {
                    type: 'line',
                    label: 'Dose 1 accumulation',
                    yAxisID: 'Acc',
                    borderColor: CHART_COLORS.red,
                    pointRadius: 2,
                    pointStyle: 'rectRot',
                    data: dose1Sum
                },
                {
                    type: 'line',
                    label: 'Dose 2 accumulation',
                    yAxisID: 'Acc',
                    borderColor: CHART_COLORS.blue,
                    pointRadius: 2,
                    pointStyle: 'rectRot',
                    data: dose2Sum
                }]
        };

        myChart = new Chart(document.getElementById("SlovakiaVaccinations").getContext("2d"), {
            type: 'scatter',
            data: data,
            options: {
                plugins: {
                    title: {
                        display: true,
                        text: "Vaccination in Slovakia"
                    },
                    tooltip: {
                        callbacks: {
                            label: (tooltipItem, data) => (`${myChart.data.datasets[tooltipItem.datasetIndex].data[tooltipItem.dataIndex]}`)
                        }
                    }
                },
                scales: {
                    Dose: {
                        type: 'linear',
                        position: 'left'
                    },
                    Acc: {
                        type: 'linear',
                        position: 'right'
                    }
                },
                hover: {
                    mode: 'point',
                },
                responsive: true
            }
        });
    }

    plotDose1();
    function plotDose1() {
        const data = {
            labels: publishedOn,
            datasets: [
                {
                    type: 'bar',
                    label: "Dose 1",
                    backgroundColor: BACKGROUND_CHART_COLORS.red,
                    borderColor: CHART_COLORS.red,
                    borderWidth: 2,
                    data: dose1Count
                }]
        };

        var myChart = new Chart(document.getElementById("Dose1Vaccination").getContext("2d"),
            {
                type: 'scatter',
                data: data,
                options: {
                    plugins: {
                        title: {
                            display: true,
                            text: "Vaccination in Slovakia"
                        },
                        tooltip: {
                            callbacks: {
                                label: (tooltipItem, data) => (`${myChart.data.datasets[tooltipItem.datasetIndex].data[tooltipItem.dataIndex]}`)
                            }
                        }
                    },
                    hover: {
                        mode: 'point',
                    },
                    responsive: true
                }
            });
    }


</script>

</main>
</body>

</html>